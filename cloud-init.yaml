#cloud-config
package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - jq
  - openssl

write_files:
  - path: /opt/kong/docker-compose.yml
    content: |
      version: '3.8'

      services:
        kong:
          image: kong:3.4
          container_name: kong
          restart: unless-stopped
          environment:
            KONG_DATABASE: postgres
            KONG_PG_HOST: ${postgres_host}
            KONG_PG_USER: ${postgres_user}
            KONG_PG_PASSWORD: ${postgres_password}
            KONG_PG_DATABASE: ${postgres_database}
            KONG_PG_SSL: "on"
            KONG_PROXY_ACCESS_LOG: /dev/stdout
            KONG_ADMIN_ACCESS_LOG: /dev/stdout
            KONG_PROXY_ERROR_LOG: /dev/stderr
            KONG_ADMIN_ERROR_LOG: /dev/stderr
            KONG_ADMIN_LISTEN: 0.0.0.0:8001
            KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl
          ports:
            - "8000:8000"
            - "8001:8001"
            - "8443:8443"
          networks:
            - kong-net
          healthcheck:
            test: ["CMD", "kong", "health"]
            interval: 10s
            timeout: 10s
            retries: 10

        nginx:
          image: nginx:alpine
          container_name: nginx-upstream
          restart: unless-stopped
          volumes:
            - /opt/kong/nginx-html:/usr/share/nginx/html:ro
          networks:
            - kong-net

      networks:
        kong-net:
          driver: bridge
    permissions: '0644'

  - path: /opt/kong/nginx-html/index.html
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>Kong Certificate PoC</title>
          <style>
              body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
              .container { background: white; padding: 30px; border-radius: 8px; max-width: 600px; margin: 0 auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              h1 { color: #1a365d; }
              .success { color: #2f855a; font-weight: bold; }
              .info { background: #e2e8f0; padding: 15px; border-radius: 4px; margin-top: 20px; }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>Kong Certificate PoC</h1>
              <p class="success">TLS termination successful!</p>
              <p>This page is served via:</p>
              <ol>
                  <li>Kong Gateway (TLS termination with Key Vault certificate)</li>
                  <li>Nginx upstream service</li>
              </ol>
              <div class="info">
                  <strong>Architecture:</strong><br>
                  Internet → Kong (8443 HTTPS) → Nginx (80 HTTP)
              </div>
          </div>
      </body>
      </html>
    permissions: '0644'

  - path: /opt/kong/scripts/fetch-cert.sh
    content: |
      #!/bin/bash
      set -e

      KEYVAULT_NAME="${keyvault_name}"
      CERT_NAME="test-certificate"
      KONG_ADMIN_URL="http://localhost:8001"
      IDENTITY_CLIENT_ID="${identity_client_id}"

      echo "=== Fetching certificate from Azure Key Vault ==="

      # Login with managed identity
      echo "Logging in with managed identity..."
      az login --identity --allow-no-subscriptions --client-id "$IDENTITY_CLIENT_ID"

      # Download the certificate (PFX format)
      echo "Downloading certificate..."
      az keyvault secret download \
        --vault-name "$KEYVAULT_NAME" \
        --name "$CERT_NAME" \
        --file /tmp/cert.pfx \
        --encoding base64

      # Convert PFX to PEM (certificate)
      echo "Extracting certificate..."
      openssl pkcs12 -in /tmp/cert.pfx -clcerts -nokeys -out /tmp/cert.pem -passin pass:

      # Convert PFX to PEM (private key)
      echo "Extracting private key..."
      openssl pkcs12 -in /tmp/cert.pfx -nocerts -nodes -out /tmp/key.pem -passin pass:

      # Read certificate and key
      CERT=$(cat /tmp/cert.pem)
      KEY=$(cat /tmp/key.pem)

      # Upload to Kong
      echo "Uploading certificate to Kong..."
      CERT_RESPONSE=$(curl -s -X POST "$KONG_ADMIN_URL/certificates" \
        -F "cert=$CERT" \
        -F "key=$KEY" \
        -F "snis[]=test.example.com" \
        -F "snis[]=*.example.com")

      CERT_ID=$(echo "$CERT_RESPONSE" | jq -r '.id')

      if [ "$CERT_ID" != "null" ] && [ -n "$CERT_ID" ]; then
        echo "Certificate uploaded successfully!"
        echo "Certificate ID: $CERT_ID"
      else
        echo "Failed to upload certificate"
        echo "$CERT_RESPONSE"
        exit 1
      fi

      # Cleanup
      rm -f /tmp/cert.pfx /tmp/cert.pem /tmp/key.pem

      echo "=== Certificate setup complete ==="
    permissions: '0755'

  - path: /opt/kong/scripts/setup-kong-route.sh
    content: |
      #!/bin/bash
      set -e

      KONG_ADMIN_URL="http://localhost:8001"

      echo "=== Setting up Kong route ==="

      # Create upstream
      echo "Creating upstream..."
      curl -s -X POST "$KONG_ADMIN_URL/upstreams" \
        -d "name=nginx-upstream" || true

      # Add target to upstream
      echo "Adding target to upstream..."
      curl -s -X POST "$KONG_ADMIN_URL/upstreams/nginx-upstream/targets" \
        -d "target=nginx-upstream:80" || true

      # Create service
      echo "Creating service..."
      curl -s -X POST "$KONG_ADMIN_URL/services" \
        -d "name=nginx-service" \
        -d "host=nginx-upstream" \
        -d "port=80" \
        -d "protocol=http" || true

      # Create route for HTTPS
      echo "Creating route..."
      curl -s -X POST "$KONG_ADMIN_URL/services/nginx-service/routes" \
        -d "name=nginx-route" \
        -d "protocols[]=https" \
        -d "hosts[]=test.example.com" \
        -d "paths[]=/" \
        -d "strip_path=false" || true

      echo ""
      echo "=== Kong route setup complete ==="
      echo ""
      echo "Test with:"
      echo "  curl -k https://localhost:8443 -H 'Host: test.example.com'"
      echo ""
      echo "Or from external:"
      echo "  curl -k https://<public-ip>:8443 -H 'Host: test.example.com'"
    permissions: '0755'

runcmd:
  # Install Docker
  - curl -fsSL https://get.docker.com | sh
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ${vm_admin_username}

  # Install Docker Compose
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose

  # Install Azure CLI
  - curl -sL https://aka.ms/InstallAzureCLIDeb | bash

  # Wait for PostgreSQL to be ready (may take a few minutes)
  - sleep 60

  # Run Kong migrations
  - |
    docker run --rm \
      -e KONG_DATABASE=postgres \
      -e KONG_PG_HOST=${postgres_host} \
      -e KONG_PG_USER=${postgres_user} \
      -e KONG_PG_PASSWORD=${postgres_password} \
      -e KONG_PG_DATABASE=${postgres_database} \
      -e KONG_PG_SSL=on \
      kong:3.4 kong migrations bootstrap

  # Start Kong and Nginx
  - cd /opt/kong && docker-compose up -d

  # Wait for services to be healthy
  - sleep 30

  - echo "Cloud-init completed. Run /opt/kong/scripts/fetch-cert.sh to load certificate."
